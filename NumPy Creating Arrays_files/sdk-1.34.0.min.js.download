(()=>{var t,e,i,s={d:(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},r={};s.d(r,{default:()=>g});class o{_message;_code;constructor(t,e){this._message=t,this._code=e}get message(){return this._message}get code(){return this._code}}class n extends o{constructor(t){super(`First-id cookie "${t}" not found`,"FirstIdCookieNotFound")}}class a extends o{constructor(){super('The config "emailGetterCallback" must be a function',"FirstIdEmailGetterCallbackIsNotFunction")}}class c extends o{constructor(t){super(`First-id cookie "${t}" contains an empty value`,"FirstIdEmptyValue")}}class h extends o{constructor(){super("The current user has opted out of tracking","FirstIdUserDoNotTrack")}}const d={API_URL:"https://api-v4.prod.first-id.fr",API_V6_URL:"https://api-v6.prod.first-id.fr",API_DUAL_URL:"https://api-dual.prod.first-id.fr",API_URL_PAGE_VIEW:"https://api-pv.prod.first-id.fr",BASE_HTML_URL:"https://cdn.first-id.fr/sdk/html",SDK_VERSION:"1.34.0",COOKIE_NAME:"firstid",VENDOR_ID:1178,FLEX:"false",TCF_ENABLED:!0,PREMIUM_LITE:"false",ADAPTIVE_FEATURE:"false",GATE_URL:"https://gate.preprod.first-id.fr",HEALTH_CHECK_URL:"https://healthcheck-ak.prod.first-id.fr/check"};i=t=t||{},i[i.StoreAndAccessInformationOnADevice=1]="StoreAndAccessInformationOnADevice",i[i.SelectBasicAds=2]="SelectBasicAds",i[i.CreateAPersonalizedAdsProfile=3]="CreateAPersonalizedAdsProfile",i[i.SelectPersonalizedAds=4]="SelectPersonalizedAds",i[i.CreateAPersonalizedContentProfile=5]="CreateAPersonalizedContentProfile",i[i.SelectPersonalizedContent=6]="SelectPersonalizedContent",i[i.MeasureAdPerformance=7]="MeasureAdPerformance",i[i.MeasureContentPerformance=8]="MeasureContentPerformance",i[i.ApplyMarketResearchToGenerateAudienceInsights=9]="ApplyMarketResearchToGenerateAudienceInsights",i[i.DevelopAndImproveProducts=10]="DevelopAndImproveProducts",i=e=e||{},i[i.UsePreciseGeolocationData=1]="UsePreciseGeolocationData",i[i.ActivelyScanDeviceCharacteristicsForIdentification=2]="ActivelyScanDeviceCharacteristicsForIdentification";class l{_version;_emailHashed;_tcstring;intervalReferenceRequestFirstIdFromParent;logger;vendorId=1178;requiredPurposes=[t.StoreAndAccessInformationOnADevice,t.SelectBasicAds,t.CreateAPersonalizedAdsProfile,t.SelectPersonalizedAds,t.MeasureAdPerformance];_consent;specialFeatures=[e.ActivelyScanDeviceCharacteristicsForIdentification];isInitialized=!1;incognitoModeStatus=-1;ipV4CacheState="not_fetched";ipV6CacheState="not_fetched";cachedIpV4=null;cachedIpV6=null;premiumLiteRedirectKey="fid_premium_lite_redirect";constructor(){this._version=d.SDK_VERSION,this.intervalReferenceRequestFirstIdFromParent=null,this._firstId=null,this._emailHashed=null,this._tcstring=null,this._config={callbacks:[],cookieName:d.COOKIE_NAME,cookieNameFlexType:d.COOKIE_NAME+"_flex_type",cookieNameTTLInMinute:259200,version:this._version,debug:!1,isIframe:!1,intervalRequestFirstIdFromParentMs:100,callbacksWhenIframeReceiveFirstId:[],iframeAppendFirstIdToLinkCssSelector:[],emailCookieName:"fid_email_hashed",emailHashed:null,emailHashCookieName:"fid_email_hash",emailHashCookieTTL:259200,emailGetterCallback:null,consentCookieName:"fidsdk_consent",consentCookieTTL:259200,customDataHashCookieName:"fid_customdata_hash",customDataHashCookieTTL:259200,firstIdFlexFeature:"true"===d.FLEX,syncIpUaCookieName:"fidflexlastsync",syncFidEmailCookieName:"fidflexemaillastsync",refreshCookieName:"firstid_refresh",flexLastCheckCookieName:"fidflexlastcheck",firstIdApiBaseUrl:d.API_URL,firstIdApiV6BaseUrl:d.API_V6_URL,firstIdApiDualBaseUrl:d.API_DUAL_URL,firstIdApiPageViewBaseUrl:d.API_URL_PAGE_VIEW,xhrTimeoutInMs:3e3,premiumLiteRedirectMarkerExpirationInMinutes:5,premiumLiteCustomRedirectHost:void 0,cookieSyncEnabled:!0,cookieSyncCallbackUrl:d.BASE_HTML_URL+"/cookie-sync.html",cookieSyncTimeout:2e3,cookieSyncPartners:[{name:"Equativ",buildUrl:(t,e)=>{const i=new URL("https://sync.smartadserver.com/getuid");return i.searchParams.set("url",e.replace("[PARTNER_ID]","[sas_uid]")),i.searchParams.set("gdpr","1"),i.searchParams.set("gdpr_consent",t),i.toString()},canSync:()=>{const t=[];return!t.includes(window.location.hostname.split(".").slice(-2).join("."))}},{name:"Weborama",buildUrl:(t,e)=>{const i=e.replace("[PARTNER_ID]","{WEBO_CID}"),s=new URL("https://rd.frontend.weborama.fr/rd");return s.searchParams.set("url",i),s.searchParams.set("gdpr","1"),s.searchParams.set("gdpr_consent",t),s.toString()},canSync:()=>{const t=[];return t.includes(window.location.hostname.split(".").slice(-2).join("."))}}],...window.firstId||{}},this.logger={log:()=>{this.config.debug||window?.firstId?.debug},debug:()=>{this.config.debug||window?.firstId?.debug},error:()=>{this.config.debug||window?.firstId?.debug},warn:()=>{this.config.debug||window?.firstId?.debug}},this.logger.debug("First-id SDK initialized. Current version is : "+this._version);try{this.checkPostRedirection()&&this.handlePostRedirection()}catch(t){this.logger.error("Error premium lite post redirection",t)}try{const t=this.getId();this._setOutbrainPPID(t),this._addFirstIdToGoogleSecureSignal(t)}catch(t){this.logger.error("Error on set outbrain PPID",t)}}_firstId;_firstIdType;get firstId(){return this.firstIdStruct?.firstId??null}set firstId(t){this.firstIdStruct={firstId:t}}get firstIdStruct(){return this.getFirstIdStruct()}set firstIdStruct(t){const e=t?.firstId&&(!this._firstId||this._firstId!==t?.firstId);if(this._firstId=t?.firstId,this._firstIdType=t?.t,document&&window&&(window.__FIRSTID__=t?.firstId,document.__FIRSTID__=t?.firstId,0),this.consent){this._setFirstIdCookie(t);try{this._setOutbrainPPID(t?.firstId)}catch(t){this.logger.error("Error on set outbrain PPID",t)}try{this._addFirstIdToGoogleSecureSignal(t?.firstId)}catch(t){this.logger.error("Error on set google secure signal",t)}e&&this._sendEvent("firstId:new",{firstId:t?.firstId})}else this.logger.debug("No consent, skip setting FirstID on storage and APIs")}_config;get config(){return this.getConfig()}set config(t){if(518400<t.cookieNameTTLInMinute)throw new Error("cookieNameTTLInMinute must be less than 12 months");this._config=t}get consent(){const t=t=>{try{return t()}catch(t){return!1}};return t(()=>!!this._consent)||t(()=>!JSON.parse(d.TCF_ENABLED))}set consent(t){this._consent=t}get version(){return this._version}getFirstId(){return this.getFirstIdStruct()?.firstId??null}getFirstIdStruct(){if(this._config.isIframe&&this._firstId)return{firstId:this._firstId,t:this._firstIdType};let t=this.__getCookieValueFromCookieName(this._config.cookieName);if(null===t&&!this.config.firstIdFlexFeature)throw new n(this._config.cookieName);if(""===t)throw new c(this._config.cookieName);if("NO_TRACKING"===t)throw new h;const e=this.__getCookieValueFromCookieName(this._config.cookieNameFlexType);return{firstId:t,t:this.normalizeToInteger(e)}}async waitForInitialization(){for(;!this.isInitialized;)await new Promise(t=>setTimeout(t,100))}getParameterByName(t,e=window.location.href){if(!t)throw new Error("ConfigError: A name should be specified");const i=t.replace(/[[\]]/g,"\\$&"),s=new RegExp(`[?&]${i}(=([^&#]*)|&|#|$)`),r=s.exec(e);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}getEmailHashed(){if(this._emailHashed??this._config.emailHashed)return this._emailHashed??this._config.emailHashed;let t=null,e=this.getParameterByName("nlsha");if(this._config.emailCookieName&&this.__getCookieValueFromCookieName(this._config.emailCookieName))t=this.__getCookieValueFromCookieName(this._config.emailCookieName);else if(e)t=e;else if(this._config.getEmailMethod)try{t=this._config.getEmailMethod()}catch(t){this.logger.error("[FIRSTID] Error on getEmailMethod",t)}return t}getFirstIdEidsObject=()=>[{source:"first-id.fr",uids:[{atype:1,ext:{stype:"ppuid"},id:this.getId()}]}];getCookieName(){return this._config.cookieName}setCookieName(t){this._config.cookieName=t}askFirstIdToParentIframe(){const t=()=>{this.logger.debug(`Request FirstID from parent each ${this._config.intervalRequestFirstIdFromParentMs} ms...`),window.top.postMessage("requestFirstID","*")};this._config.intervalReferenceRequestFirstIdFromParent=setInterval(t,this._config.intervalRequestFirstIdFromParentMs),window.addEventListener("message",t=>{this.logger.log("message from parent",t),this.logger.debug("[FIRSTID IFRAME] message from parent",t),t.data.firstid&&(clearInterval(this._config.intervalReferenceRequestFirstIdFromParent),this.logger.debug("[FIRSTID IFRAME] iFrame has been receive successfully firstID "+t.data.firstid,t),this._firstId=t.data.firstid,t.data.firstid,t.source.postMessage("firstidACK","*"),this.iframeAppendFirstIdToLink(),this._config.callbacksWhenIframeReceiveFirstId.forEach((e,i)=>{this.logger.debug("[FIRSTID IFRAME] Invoke callback start #"+i,e);try{e(this._firstId),this.logger.debug("[FIRSTID IFRAME] Invoke callback done #"+i,e)}catch(t){this.logger.error(`[FIRSTID IFRAME] Callback #${i} throw an error`,e)}}))},!0)}async setEmailHashed(e){let i;try{i=this.getId()}catch(t){this.logger.error("Error on get FirstID",t),i=null}if(i&&this.__getCookieValueFromCookieName(this._config.emailHashCookieName)===e)this.logger.debug("[FIRSTID] Email hash already processed recently. Skipping API call.");else{if(!this.consent)return this.logger.debug("[FIRSTID] Can't set email hashed because consent is not accepted"),null;if(i){let t=await this._checkMatchCookieWithEmail(e);if(!t)return void this.logger.debug("[FIRSTID] Error on check match cookie with email");t&&!t?.match&&(this._setFirstIdCookie({firstId:t?.firstId,t:t?.t}),this._createRefreshCookie())}else{let t=await this._checkEmailExist(e);if(t?.exist)this._setFirstIdCookie({firstId:t.firstId,t:t.t}),this._createRefreshCookie();else{let t=await this._createFirstIdByEmail(e);t?.firstId&&(this._setFirstIdCookie({firstId:t.firstId}),this._createRefreshCookie())}}this._setCookie(this._config.emailHashCookieName,e,this._config.emailHashCookieTTL)}}async setCustomData(t){await this.waitForInitialization(),await this._setCustomData(t)}async _setCustomData(e){for(var t in e)if("string"!=typeof t||"string"!=typeof e[t])return void this.logger.error("[FIRSTID] Error on set custom data, key and value must be string");let i;try{i=this.getId()}catch(t){this.logger.error("Error on get FirstID",t),i=null}if(i){const s=btoa(JSON.stringify(e));if(this.__getCookieValueFromCookieName(this._config.customDataHashCookieName)===s)this.logger.debug("[FIRSTID] Custom data hash already processed recently. Skipping API call.");else{let t=await this._checkMatchCookieWithCustomData(e);t?(t&&!t?.match&&this._setFirstIdCookie({firstId:t?.firstId,t:t?.t}),this._setCookie(this._config.customDataHashCookieName,s,this._config.customDataHashCookieTTL)):this.logger.debug("[FIRSTID] Error on check match cookie with customData")}}else this.logger.debug("[FIRSTID] FirstID not found. Skipping API call.")}async killFid(){const t=this.__getCookieValueFromCookieName(this._config.cookieName,!0);if(!t||"null"!==t&&"undefined"!==t){if(this._firstId)try{let t=await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/kfid?firstId="+this.firstIdStruct?.firstId,{credentials:"include"});t.text().then(t=>{}),200===t.status&&(this.logger.debug("[FIRSTID] Delete FirstID"),this.firstIdStruct=null)}catch(t){this.logger.error("[FIRSTID] Error on delete FirstID V4 try in V6 endpoint",t);try{let t=await this._fetchWithAbortSignal(this._config.firstIdApiV6BaseUrl+"/kfid?firstId="+this.firstIdStruct?.firstId,{credentials:"include"});t.text().then(t=>{}),200===t.status&&(this.logger.debug("[FIRSTID] Delete FirstID"),this.firstIdStruct=null)}catch(t){this.logger.error("[FIRSTID] Error on delete FirstID V6",t)}}}else this.firstIdStruct=null}normalizeToInteger(t){const e=Number(t);return Number.isInteger(e)&&("number"==typeof t||"string"==typeof t&&String(e)===t.trim())?e:null}async initFlex(){const t=[];let e=window.location.hostname;this._firstId&&e&&this.config.killFidDomains.includes(e)&&t.push(this.killFid()),JSON.parse(d.TCF_ENABLED)&&t.push(this._waitForTCFConsent()),await Promise.all(t);const i=JSON.parse(d.PREMIUM_LITE)&&(!JSON.parse(d.ADAPTIVE_FEATURE)||!this.isChrome());if(i&&this.isLocalStorageAvailable())if(this.hasRedirectMarkerWithoutFirstId()){this.logger.debug("[FIRSTID] Site stripped query string after redirect, continuing with Flex logic");try{localStorage.removeItem(this.premiumLiteRedirectKey)}catch(t){this.logger.error("[FIRSTID] Failed to clean redirect marker",t)}}else{if(!this._firstId&&!this.checkPostRedirection())return void await this.premiumLite();this.checkPostRedirection()&&this.handlePostRedirection()}const s="0"===this.__getCookieValueFromCookieName(this._config.cookieNameFlexType);if(this._firstId&&!s)this._updateIpUa().then(async()=>{this._emailHashed?this._hashAlreadyCheckFirstIdEmailAssociation()||await this.setEmailHashed(this._emailHashed):await this.getMasterFirstId(),this.config.customData&&await this._setCustomData(this.config.customData)}).finally(async()=>{this._trackPageView()});else{let t=!1;try{t=!!this.firstIdStruct?.firstId}catch(t){}null!==this.__getCookieValueFromCookieName(this._config.flexLastCheckCookieName)||t&&!s?t&&(this.logger.debug("FirstID found"),this._trackPageView()):(this.logger.debug("FirstID not found, try to get it from IP and User Agent"),await this._getFirstIdByIPUA().then(async t=>{t&&(this.firstIdStruct=t,this._emailHashed?this._hashAlreadyCheckFirstIdEmailAssociation()||await this.setEmailHashed(this._emailHashed):await this.getMasterFirstId(),this.config.customData&&await this._setCustomData(this.config.customData),this._trackPageView())}))}}async initNonFlex(){let t=window.location.hostname;const e=this._firstId&&t&&this.config.killFidDomains.includes(t)?this.killFid():Promise.resolve();e.then(async()=>{const t=JSON.parse(d.TCF_ENABLED)?this._waitForTCFConsent():Promise.resolve();t.then(async()=>{const t=JSON.parse(d.PREMIUM_LITE)&&(!JSON.parse(d.ADAPTIVE_FEATURE)||!this.isChrome());if(t&&this.isLocalStorageAvailable())if(this.hasRedirectMarkerWithoutFirstId()){this.logger.debug("[FIRSTID] Site stripped query string after redirect, continuing with current logic");try{localStorage.removeItem(this.premiumLiteRedirectKey)}catch(t){this.logger.error("[FIRSTID] Failed to clean redirect marker",t)}}else{if(!this._firstId&&!this.checkPostRedirection())return void await this.premiumLite();this.checkPostRedirection()&&this.handlePostRedirection()}this._firstId&&this._updateIpUa().then(async()=>{this._emailHashed?this._hashAlreadyCheckFirstIdEmailAssociation()||await this.setEmailHashed(this._emailHashed):await this.getMasterFirstId(),this.config.customData&&await this._setCustomData(this.config.customData)}).finally(async()=>{this._trackPageView()})})})}async init(){if(this.logger.debug("SDK: init"),null!==this._config.emailGetterCallback&&"function"!=typeof this._config.emailGetterCallback)throw new a;if(this._config.isIframe)this.askFirstIdToParentIframe();else{JSON.parse(d.TCF_ENABLED)||this._getTCString(),this._addListerFromIframeMessage();try{const t=this.getIdStruct();this._firstId=t?.firstId??null,this._firstIdType=t?.t??null}catch(t){this._firstId=null,this._firstIdType=null}this.incognitoModeStatus=await this._detectIncognitoMode(),this.logger.debug("[FIRSTID] Incognito mode status:",this.incognitoModeStatus);try{this._emailHashed=this.getEmailHashed()}catch(t){this._emailHashed=null}this._config.firstIdFlexFeature?await this.initFlex():await this.initNonFlex(),this.isInitialized=!0,this._sendEvent("firstId:initialized",{firstId:this._firstId})}}isLocalStorageAvailable(){try{const t="fid_test_storage";return localStorage.setItem(t,"1"),localStorage.removeItem(t),localStorage.getItem(t),!0}catch(t){return this.logger.debug("[FIRSTID] localStorage is not available"),!1}}async premiumLite(){if(this._config.premiumLiteHealthCheckEnabled)try{const r=await fetch("https://healthcheck-ak.prod.first-id.fr/check");if(!r.ok)return void this.logger.error("[FIRSTID] Health check failed",r.status)}catch(t){return void this.logger.error("[FIRSTID] Error during health check",t)}const t=new URL(window.location.href),e=new URLSearchParams,i=(this._config.premiumLiteCustomRedirectHost?(this.logger.debug("[FIRSTID] Using custom redirect host for Premium Lite"),e.append("redirectHost",this._config.premiumLiteCustomRedirectHost),e.append("redirectUri",t.href),e.append("separator","?")):(this.logger.debug("[FIRSTID] Using default Premium Lite flow"),e.append("redirectHost",t.href),e.append("separator",t.href.includes("?")?"&":"?"),e.append("noRedirectUri","1")),this.getEmailHashed());i&&(e.append("email",i),this.logger.debug("[FIRSTID] Premium Lite: passing hashed email to gate"));try{localStorage.setItem(this.premiumLiteRedirectKey,Date.now().toString()),this.logger.debug("[FIRSTID] Premium Lite redirect marker set in localStorage")}catch(t){this.logger.error("[FIRSTID] Failed to set redirect marker",t)}const s=d.GATE_URL+"?"+e.toString();this.premiumLiteRedirect(s)}async premiumLiteRedirect(t){window.location.href=t}handlePostRedirection(){if(this.consent){const t=new URL(window.location.href),e=t.searchParams.get("firstId");if(e){this.firstIdStruct={firstId:e};try{localStorage.removeItem(this.premiumLiteRedirectKey),this.logger.debug("[FIRSTID] Premium Lite redirect marker removed from localStorage")}catch(t){this.logger.error("[FIRSTID] Failed to remove redirect marker",t)}}t.searchParams.delete("firstId"),window.history.replaceState({},"",t.toString())}else this.logger.debug("[FIRSTID] Can't handle post-redirection because consent is not accepted")}checkPostRedirection(){const t=new URL(window.location.href);return t.searchParams.has("firstId")}hasRedirectMarkerWithoutFirstId(){try{const t=localStorage.getItem(this.premiumLiteRedirectKey);if(t){const e=new URL(window.location.href),i=e.searchParams.has("firstId");if(!i){const s=parseInt(t,10),r=Date.now(),o=(r-s)/6e4;if(o<this._config.premiumLiteRedirectMarkerExpirationInMinutes)return this.logger.debug("[FIRSTID] Redirect marker found without firstId parameter - site likely stripped query string"),!0;localStorage.removeItem(this.premiumLiteRedirectKey),this.logger.debug("[FIRSTID] Redirect marker expired, removed")}}}catch(t){this.logger.error("[FIRSTID] Error checking redirect marker",t)}return!1}iframeAppendFirstIdToLink(){this.logger.debug("[FIRSTID IFRAME] Try to append firstID to link with the css selector",this._config.iframeAppendFirstIdToLinkCssSelector),this._config.iframeAppendFirstIdToLinkCssSelector.forEach(t=>{const e=document.querySelectorAll(t);this.logger.debug(`[FIRSTID IFRAME] Found ${e.length} links for cssSelector `+t),0!==e.length&&e.forEach(t=>{t.href&&!t.href.includes("firstid")?-1===t.href.indexOf("?")?t.href+="?firstid="+this._firstId:t.href+="&firstid="+this._firstId:t.src&&!t.src.includes("firstid")&&(-1===t.src.indexOf("?")?t.src+="?firstid="+this._firstId:t.src+="&firstid="+this._firstId)})})}getIdStruct(){if(this.config.isIframe&&this.firstIdStruct)return this.firstIdStruct;let t=this.__getCookieValueFromCookieName(this.config.cookieName);if(null===t)throw new n(this.config.cookieName);if(""===t)throw new c(this.config.cookieName);if("NO_TRACKING"===t)throw new h;const e=this.__getCookieValueFromCookieName(this.config.cookieNameFlexType)??void 0;return{firstId:t,t:this.normalizeToInteger(e)}}getId(){return this.getIdStruct()?.firstId??null}getVersion(){return this.version}getConfig(){return this._config}__getCookieValueFromCookieName(i,s=!1){let r=document.cookie.split(";");for(let e=0;e<r.length;e++){let t=r[e].split("=");const o=t[1];if(i===t[0].trim()&&(s||"null"!==o&&"undefined"!==o))return decodeURIComponent(o)}return null}_addListerFromIframeMessage(){window.addEventListener("message",t=>{if(this.logger.debug("[FIRSTID] message from iframe",t),"firstidACK"===t.data&&this.logger.log("[FIRSTID] iFrame has been receive successfully firstID",t),"requestFirstID"===t.data){this.logger.log("[FIRSTID] iFrame request firstID",t);try{t.source.postMessage({firstid:this.getId()},"*")}catch(t){this.logger.warn("[FIRSTID] Error on send firstID to iframe",t)}}},!0)}_hashAlreadyCheckFirstIdEmailAssociation(){return!!this.__getCookieValueFromCookieName(this._config.syncFidEmailCookieName)}async _getClientInfo(t){let e=this._config.customData?t+"/info?customData="+btoa(JSON.stringify(this._config.customData)):t+"/info";const i=t===this._config.firstIdApiV6BaseUrl;let s={};try{let t=await this._fetchWithAbortSignal(e);t.text().then(t=>{}),t.headers.forEach((t,e)=>{e.startsWith("x-fid-")&&(s[e]=t,"x-fid-cip"===e)&&(i?this.cachedIpV6=t:this.cachedIpV4=t)})}finally{i?this.ipV6CacheState="fetched":this.ipV4CacheState="fetched"}return this.logger.debug("Headers",s),s}async _updateIpUa(){if(this.consent)if(this._firstId){const s=[navigator?.userAgent??"",navigator?.language??"",screen?.width??0,screen?.height??0,navigator?.deviceMemory??0,navigator?.hardwareConcurrency??0].join("::");try{let t=await this._getClientInfo(this._config.firstIdApiBaseUrl),e=JSON.stringify({bd:s,...t});const r=["firstId="+this._firstId,"t="+this._firstIdType,"int="+(this.config.firstIdFlexFeature?1:0),"cache="+btoa(e),"ver="+this._version,"im="+this.incognitoModeStatus];this._config.customData&&r.push("customData="+btoa(JSON.stringify(this._config.customData))),this._config.clientId&&r.push("clientId="+encodeURIComponent(this._config.clientId));let i=await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/firstId?"+r.join("&"),{method:"POST",body:e,credentials:"include"});i.text().then(t=>{}),i.ok?this.logger.debug("[FIRSTID] Update FirstID print done"):this.logger.error("[FIRSTID] Error on update FirstID print",i.status,i.statusText)}catch(t){this.logger.error("[FIRSTID] Error on update FirstID print",t)}try{await this._getClientInfo(this._config.firstIdApiV6BaseUrl).then(t=>{let e=JSON.stringify({bd:s,...t});const i=["firstId="+this._firstId,"t="+this._firstIdType,"int="+(this.config.firstIdFlexFeature?1:0),"cache="+btoa(e),"ver="+this._version,"im="+this.incognitoModeStatus];this._config.customData&&i.push("customData="+btoa(JSON.stringify(this._config.customData))),this._config.clientId&&i.push("clientId="+encodeURIComponent(this._config.clientId)),this._fetchWithAbortSignal(this._config.firstIdApiV6BaseUrl+"/firstId?"+i.join("&"),{method:"POST",body:e,credentials:"include"}).then(t=>{t.text().then(t=>{}),this.logger.debug("[FIRSTID][V6] Update FirstID print done")}).catch(t=>{this.logger.error("[FIRSTID][V6] Error on update FirstID print",t),this._fetchWithAbortSignal(this._config.firstIdApiDualBaseUrl+"/firstId?"+i.join("&"),{method:"POST",body:e,credentials:"include"}).then(t=>(this.logger.debug("[FIRSTID][DUAL] Update FirstID print done"),t.text())).catch(t=>{this.logger.error("[FIRSTID][DUAL] Error on update FirstID print",t)})})}).catch(t=>{this.logger.error("[FIRSTID][V6] Error on get client info",t)})}catch(t){this.logger.error("[FIRSTID][V6] Error on get client info",t)}}else this.logger.debug("[FIRSTID] Can't update ip and ua because firstId is null");else this.logger.debug("[FIRSTID] Can't update ip and ua because consent is not accepted")}async _checkMatchCookieWithEmail(t){if(!this.consent)return this.logger.debug("[FIRSTID] Can't check match cookie with email because consent is not accepted"),null;if(this._firstId){const e=["firstId="+this.firstIdStruct?.firstId,"t="+this.firstIdStruct?.t,"email="+t,"im="+this.incognitoModeStatus,"ver="+this._version,"c="+btoa(JSON.stringify({u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"}))],i=(this._config.clientId&&e.push("clientId="+encodeURIComponent(this._config.clientId)),await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/emailAssoc?"+e.join("&"),{signal:AbortSignal.timeout(this._config.xhrTimeoutInMs),credentials:"include"}));if(i.ok&&204!==i.status){const s=await i.json();if("firstId"in s&&"match"in s)return this.logger.debug("[FIRSTID] Check match cookie with email done"),s;this.logger.error("[FIRSTID] API response is missing firstId property")}else this.logger.error("[FIRSTID] Error on check match cookie with email",i.status,i.statusText),i.text().then(t=>{this.logger.error("[FIRSTID] Error on check match cookie with email",t)});return null}this.logger.debug("[FIRSTID] Can't check match cookie with email because firstId is null")}async _checkMatchCookieWithCustomData(t){if(!this.consent)return this.logger.debug("[FIRSTID] Can't check match cookie with custom data because consent is not accepted"),null;if(this._firstId){const e=["firstId="+this.firstIdStruct?.firstId,"t="+this.firstIdStruct?.t,"customData="+btoa(JSON.stringify(t)),"im="+this.incognitoModeStatus,"ver="+this._version,"c="+btoa(JSON.stringify({u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"}))],i=(this._config.clientId&&e.push("clientId="+encodeURIComponent(this._config.clientId)),await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/customDataAssoc?"+e.join("&"),{credentials:"include"}));if(i.ok&&204!==i.status){const s=await i.json();if("firstId"in s&&"match"in s)return this.logger.debug("[FIRSTID] Check match cookie with custom data done"),s;this.logger.error("[FIRSTID] API response is missing firstId property")}else this.logger.error("[FIRSTID] Error on check match cookie with custom data",i.status,i.statusText),i.text().then(t=>{this.logger.error("[FIRSTID] Error on check match cookie with custom data",t)});return null}this.logger.debug("[FIRSTID] Can't check match cookie with custom data because firstId is null")}_setFirstIdCookie(t){t?.firstId?(this._setCookie(this._config.cookieName,t.firstId,this._config.cookieNameTTLInMinute),this._setCookie(this._config.cookieNameFlexType,""+(t?.t??""),this._config.cookieNameTTLInMinute)):(this._setCookie(this._config.cookieName,"",-100),this._setCookie(this._config.cookieNameFlexType,"",-100))}_createRefreshCookie(){this._setCookie(this._config.refreshCookieName,"1",this._config.cookieNameTTLInMinute)}async _checkEmailExist(t){if(this.consent){const e=["email="+t,"im="+this.incognitoModeStatus,"ver="+this._version,"c="+btoa(JSON.stringify({u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"}))],i=(this._config.clientId&&e.push("clientId="+encodeURIComponent(this._config.clientId)),await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/emailExist?"+e.join("&"),{signal:AbortSignal.timeout(this._config.xhrTimeoutInMs),credentials:"include"}));if(i.ok&&204!==i.status){const s=await i.json();if("firstId"in s&&"exist"in s)return this.logger.debug("[FIRSTID] Check email exist done"),s;this.logger.error("[FIRSTID] API response is missing firstId property")}else this.logger.error("[FIRSTID] Error on check email exist",i.status,i.statusText),i.text().then(t=>{this.logger.error("[FIRSTID] Error on check email exist",t)})}else this.logger.debug("[FIRSTID] Can't check email exist because consent is not accepted");return null}async _createFirstIdByEmail(t){if(this.consent){const e={email:t,u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0",im:this.incognitoModeStatus,ver:this._version},i=(this._config.clientId&&(e.clientId=this._config.clientId),await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/createFidViaEmail",{method:"POST",body:JSON.stringify(e),mode:"no-cors",credentials:"include"}));if(i.ok&&204!==i.status){const s=await i.json();if("firstId"in s)return this.logger.debug("[FIRSTID] Create first-id by email done"),s;this.logger.error("[FIRSTID] API response is missing firstId property")}else this.logger.error("[FIRSTID] Error on create first-id by email",i.status,i.statusText),i.text().then(t=>{this.logger.error("[FIRSTID] Error on create first-id by email",t)})}else this.logger.debug("[FIRSTID] Can't create first-id by email because consent is not accepted");return null}async _getFirstIdByIPUA(){if(this.consent){const i=async t=>{const e=await t.json();return"firstId"in e?(0!==e.t&&"0"!==e.t||this._setCookie(this._config.flexLastCheckCookieName,"1",360),e):(this.logger.error("[FIRSTID] API response is missing firstId property"),null)},t=[navigator?.userAgent??"",navigator?.language??"",screen?.width??0,screen?.height??0,navigator?.deviceMemory??0,navigator?.hardwareConcurrency??0].join("::");let e=null;const s=["int="+(this.config.firstIdFlexFeature?1:0),"bs="+encodeURIComponent(t),"ver="+this._version,"im="+this.incognitoModeStatus];this._config.customData&&s.push("customData="+btoa(JSON.stringify(this._config.customData))),this._config.clientId&&s.push("clientId="+encodeURIComponent(this._config.clientId));try{this._firstId&&(s.push("firstid="+this.firstIdStruct.firstId),"number"==typeof this._firstIdType)&&s.push("firstid_t="+this._firstIdType)}catch(t){}try{if(e=await this._fetchWithAbortSignal(this._config.firstIdApiV6BaseUrl+"/firstId?"+s.join("&"),{credentials:"include"}),404===e.status||204===e.status){if(e=await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/firstId?"+s.join("&"),{credentials:"include"}),404===e.status||204===e.status)this.logger.debug("[FIRSTID] Can't get first-id by print"),this._setCookie(this._config.flexLastCheckCookieName,"1",360);else{if(e.ok)return this.logger.debug("[FIRSTID] Get first-id by print done"),i(e);this.logger.error("[FIRSTID] Error on get first-id by print",e.status,e.statusText)}e.text().then(t=>{})}else{if(e.ok)return this.logger.debug("[FIRSTID] Get first-id by print done"),i(e);this.logger.error("[FIRSTID] Error on get first-id by print",e.status,e.statusText),e.text().then(t=>{})}}catch(t){if(e=await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/firstId?"+s.join("&"),{credentials:"include"}),404===e.status||204===e.status)this.logger.debug("[FIRSTID] Can't get first-id by print"),this._setCookie(this._config.flexLastCheckCookieName,"1",360);else{if(e.ok)return this.logger.debug("[FIRSTID] Get first-id by print done"),i(e);this.logger.error("[FIRSTID] Error on get first-id by print",e.status,e.statusText)}e.text().then(t=>{})}}else this.logger.debug("[FIRSTID] Can't get first-id by print because consent is not accepted")}_setOutbrainPPID(t){window.OB_ppids=window.OB_ppids||[];const e={name:"first-id.fr",value:t};window.OB_ppids.push(e)}_setCookie(s,r,o){if(this.consent){let t=new Date;null==r||"null"===r||""===r?t.setTime(t.getTime()-864e5):t.setTime(t.getTime()+60*o*1e3);const n="expires="+t.toUTCString();let e,i=(e=this.config.cookieDomain?"."===this.config.cookieDomain.charAt(0)?this.config.cookieDomain:"."+this.config.cookieDomain:window.location.hostname.split(".").slice(-2).join("."),"");"https:"===window.location.protocol&&(i=";Secure"),document.cookie=s+"="+r+"; "+n+"; path=/; domain="+e+i}else this.logger.debug("[FIRSTID] Can't set cookie because consent is not accepted")}_addFirstIdToGoogleSecureSignal(e){window.googletag=window.googletag??{},window.googletag.secureSignalProviders=window.googletag.secureSignalProviders??[],window.googletag.secureSignalProviders.push({id:"first-id.fr",collectorFunction:()=>new Promise(t=>{t(e)})})}_updateConsent(e){const t=e.vendor.consents[this.vendorId],i=this.requiredPurposes.every(t=>e.purpose.consents[t]),s=!0;if(t&&i&&s)return this.consent=!0,this._tcstring=e.tcString||null,this.logger.log("[FIRSTID] User has given consent for all required purposes, vendor, and special features."),this._setCookie(this._config.consentCookieName,"1",this._config.consentCookieTTL),!0;{this.logger.log("[FIRSTID] User has not given consent for all required purposes or vendor."),t||this.logger.log("[FIRSTID] Missing vendor consent for vendor ID "+this.vendorId);const r=this.requiredPurposes.filter(t=>!e.purpose.consents[t]),o=(0<r.length&&this.logger.log("[FIRSTID] Missing purpose consents: "+r.join(", ")),this.specialFeatures.filter(t=>!e.specialFeatureOptins[t]));0<o.length&&this.logger.log("[FIRSTID] Missing special feature consents: "+o.join(", "))}return!1}_waitForTCFConsent(){if(JSON.parse(d.TCF_ENABLED)){const t=()=>new Promise(t=>{const e=()=>{window.__tcfapi?t(window.__tcfapi):setTimeout(e,100)};e()});return new Promise(i=>{const e=(t,e)=>{if(e)switch(t.eventStatus){case"tcloaded":case"useractioncomplete":this._updateConsent(t),this.consent&&i(!0);break;case"cmpuishown":this.logger.log("CMP UI is shown.");break;default:this.logger.log("Unknown eventStatus:",t.eventStatus)}else this.logger.log("Listening for TCF updates failed.")};t().then(t=>{t("addEventListener",2,e)})})}}async _ensureIpCacheLoaded(){const t=[];"not_fetched"===this.ipV4CacheState&&t.push(this._getClientInfo(this._config.firstIdApiBaseUrl)),"not_fetched"===this.ipV6CacheState&&t.push(this._getClientInfo(this._config.firstIdApiV6BaseUrl)),0<t.length&&await Promise.allSettled(t)}_getPubcid(){try{let t=null;if(this.isLocalStorageAvailable()&&(t=localStorage.getItem("_pubcid")||localStorage.getItem("_sharedID"),t))return t;const e=document.cookie.match(/(?:^|;)\s*(_pubcid|_sharedID)=([^;]+)/);return e?e[2]:null}catch(t){return this.logger.error("[FIRSTID] Error retrieving pubcid/sharedID",t),null}}async _getXandrUid(t){try{if(!t||!["apntag","pbjs","__anq","Xandr"].some(t=>t in window))return null;const e="https://ib.adnxs.com/getuidj?gdpr=1&gdpr_consent="+encodeURIComponent(t),i=await this._fetchWithAbortSignal(e,{credentials:"include"});if(!i.ok)return this.logger.error("[FIRSTID] Error retrieving Xandr UID",i.status,i.statusText),null;const s=await i.json(),r=s?.uid2??s?.uid??null;return r?this.logger.debug("[FIRSTID] Xandr UID retrieved successfully:",r):this.logger.debug("[FIRSTID] No Xandr UID returned"),r}catch(t){return this.logger.error("[FIRSTID] Error retrieving Xandr UID",t),null}}async _executeCookieSyncs(){if(!this._config.cookieSyncEnabled||!this._config.cookieSyncPartners.length)return{};const a=this._tcstring??"",c={},t=this._config.cookieSyncPartners.map(n=>new Promise(e=>{if(n.canSync()){const t=`${this._config.cookieSyncCallbackUrl}?id=[PARTNER_ID]&from=${encodeURIComponent(n.name)}&firstid=`+this._firstId,i=n.buildUrl(a,t),s=(this.logger.debug("[FIRSTID] Starting cookie sync for "+n.name),document.createElement("iframe")),r=(s.style.cssText="position:absolute;width:0;height:0;border:0;visibility:hidden;",s.src=i,setTimeout(()=>{this.logger.debug("[FIRSTID] Cookie sync timeout for "+n.name),s.parentNode&&document.body.removeChild(s),e()},this._config.cookieSyncTimeout)),o=t=>{"firstid-cookie-sync"===t.data?.type&&t.data?.from===n.name&&(this.logger.debug(`[FIRSTID] Cookie sync received for ${n.name}: `+t.data.id),c[n.name]=t.data.id,clearTimeout(r),window.removeEventListener("message",o),s.parentNode&&document.body.removeChild(s),e())};window.addEventListener("message",o),document.body.appendChild(s)}else this.logger.debug("[FIRSTID] Cookie sync skipped for "+n.name),e()}));return await Promise.all(t),this.logger.debug("[FIRSTID] Cookie syncs completed:",c),c}_trackPageView(){if(this.consent){const t=async()=>{await this._ensureIpCacheLoaded();const t=await this._executeCookieSyncs(),i=["p="+encodeURIComponent(window.location.href),"fid="+this._firstId,"fidt="+this._firstIdType,"fidclientId="+encodeURIComponent(this._config.clientId??""),"screenWidth="+(screen?.width??0),"screenHeight="+(screen?.height??0),"im="+this.incognitoModeStatus,"ver="+this._version,"tcstr="+(this._tcstring??"")],e=(this.cachedIpV4&&i.push("ipv4="+encodeURIComponent(this.cachedIpV4)),this.cachedIpV6&&i.push("ipv6="+encodeURIComponent(this.cachedIpV6)),this._getPubcid());if(e&&i.push("pubcid="+encodeURIComponent(e)),this._tcstring){const r=await this._getXandrUid(this._tcstring);r&&i.push("xandrUid="+encodeURIComponent(r))}Object.entries(t).forEach(([t,e])=>{i.push(t.toLowerCase().replace(" ","_")+"="+encodeURIComponent(e))});const s=this._config.firstIdApiPageViewBaseUrl+"/pv?"+i.join("&");fetch(s,{}).then(t=>{t.text().then(t=>{}),this.logger.debug("[FIRSTID] Page view done")}).catch(t=>{this.logger.error("[FIRSTID] Error on page view",t)})};null===this._tcstring?setTimeout(()=>{t()},1e3):t()}else this.logger.debug("No consent, skip setting track page view.")}async _fetchWithAbortSignal(t,e){const i=new AbortController,s=i.signal,r=setTimeout(()=>i.abort(),this._config.xhrTimeoutInMs),o=await fetch(t,{...e,signal:s});return clearTimeout(r),o}_sendEvent(e,t){try{document.dispatchEvent(new CustomEvent(e,{detail:t}))}catch(t){this.logger.error("Error on dispatch event "+e,t)}}async getDeviceId(){if(this.consent){const t=[navigator?.userAgent??"",navigator?.language??"",screen?.width??0,screen?.height??0,navigator?.deviceMemory??0,navigator?.hardwareConcurrency??0].join("::");let e=null;const i=["int="+(this.config.firstIdFlexFeature?1:0),"bs="+encodeURIComponent(t),"ver="+this._version,"im="+this.incognitoModeStatus];this._config.clientId&&i.push("clientId="+encodeURIComponent(this._config.clientId));try{if(e=await this._fetchWithAbortSignal(this._config.firstIdApiV6BaseUrl+"/deviceBrowserId?"+i.join("&"),{credentials:"include"}),404===e.status||204===e.status)return this.logger.debug("[FIRSTID] No device id found"),e.text().then(t=>{}),null;if(e.ok)return this.logger.debug("[FIRSTID] Get device id"),await e.json().then(t=>t.id);this.logger.error("[FIRSTID] Error on get deviceId",e.status,e.statusText),e.text().then(t=>{this.logger.error("[FIRSTID] Error on get deviceId",t)})}catch(t){try{if(e=await this._fetchWithAbortSignal(this._config.firstIdApiBaseUrl+"/deviceBrowserId?"+i.join("&"),{credentials:"include"}),404===e.status||204===e.status)return this.logger.debug("[FIRSTID] No device id found"),e.text().then(t=>{}),null;if(e.ok)return this.logger.debug("[FIRSTID] Get device id"),await e.json().then(t=>t.id);this.logger.error("[FIRSTID] Error on get deviceId",e.status,e.statusText),e.text().then(t=>{this.logger.error("[FIRSTID] Error on get deviceId",t)})}catch(t){this.logger.error("[FIRSTID] Cannot get device id",t)}}return null}this.logger.debug("[FIRSTID] Can't get first-id by print because consent is not accepted")}_getTCString(){return new Promise((i,t)=>{"function"==typeof window.__tcfapi?window.__tcfapi("getTCData",2,(t,e)=>{e&&t&&this._updateConsent(t)?i(t.tcString||null):i(null)}):(this.logger.warn("__tcfapi is not available in this context."),i(null))})}async getMasterFirstId(){if(!this.consent)return this.logger.debug("[FIRSTID] Can't get master first-id because consent is not accepted"),null;try{const t=await this._fetchWithAbortSignal(`${this._config.firstIdApiBaseUrl}/masterFirstId?firstid=${this.firstIdStruct?.firstId}&t=`+this.firstIdStruct?.t,{credentials:"include"});if(t.ok&&204!==t.status){const e=await t.json();if("firstid"in e)return this.logger.debug("[FIRSTID] Retrieved master first-id successfully"),this._setFirstIdCookie({firstId:e.firstid,t:void 0!==e.t?Number(e.t):void 0}),e.firstid;this.logger.error("[FIRSTID] API response is missing firstid property")}else this.logger.error("[FIRSTID] Error on retrieving master first-id",t.status,t.statusText),t.text().then(t=>{});return null}catch(t){return this.logger.error("[FIRSTID] Error on retrieving master first-id",t),null}}detectBrowser(){const t=navigator,e=navigator.userAgent||"",i=t.userAgentData;if(i?.brands?.length){const n=i.brands.map(t=>t.brand.toLowerCase()).join(" ");if(n.includes("chrom"))return n.includes("edge")?{engine:"Chromium",flavor:"Edge"}:n.includes("opera")||n.includes("opr")?{engine:"Chromium",flavor:"Opera"}:void 0!==t.brave?{engine:"Chromium",flavor:"Brave"}:{engine:"Chromium",flavor:"Chrome"}}const s=-1<navigator.vendor.indexOf("Apple"),r=s&&/Safari\//.test(e)&&!/Chrome|Chromium|Edg|OPR/.test(e);if(r)return{engine:"WebKit",flavor:"Safari"};const o=/Firefox\//.test(e)&&CSS.supports("(-moz-appearance: none)");return o?{engine:"Gecko",flavor:"Firefox"}:/Chrome\/|Chromium\/|Edg\/|OPR\//.test(e)?/Edg\//.test(e)?{engine:"Chromium",flavor:"Edge"}:/OPR\//.test(e)?{engine:"Chromium",flavor:"Opera"}:void 0!==navigator.brave?{engine:"Chromium",flavor:"Brave"}:{engine:"Chromium",flavor:"Chromium"}:{engine:"Unknown",flavor:"Unknown"}}isChrome(){const t=this.detectBrowser();return"Chrome"===t?.flavor}mib(t){return Math.round((t??0)/1048576)}async isIncognitoChromium(t){const e=navigator,i=window,s=this.mib(i?.performance?.memory?.jsHeapSizeLimit)||1024,r=2*s;if(e?.webkitTemporaryStorage?.queryUsageAndQuota){const o=await new Promise(s=>{e.webkitTemporaryStorage.queryUsageAndQuota((t,e)=>{const i=this.mib(e);0<i&&i<r?s(2):s(1)},()=>s(-1))});if(-1!==o)return o}try{const n=await e.storage?.estimate?.(),a=this.mib(n?.quota),c="Brave"===t?192:128;if(0<a&&a<c)return-2}catch{}try{const h=await e.storage?.persisted?.();if(!1===h);}catch{}return-1}async isIncognitoSafari(){try{const r="probe-"+Math.random().toString(36).slice(2,9),t=await new Promise(i=>{let s=!1;const t=indexedDB.open(r,1);t.onupgradeneeded=t=>{try{const e=t.target.result;e.createObjectStore("t",{autoIncrement:!0}).put(new Blob(["x"]))}catch{}},t.onsuccess=t=>{try{const e=t.target.result;e.close(),indexedDB.deleteDatabase(r)}catch{}s||(s=!0,i(!0))},t.onerror=()=>{s||(s=!0,i(!1))}});if(!1===t)return 2}catch{return-2}try{const e=navigator.storage;if(e&&"function"==typeof e.getDirectory){const i=await e.getDirectory(),s=await i.getFileHandle("probe.txt",{create:!0}),o=await s.createWritable();await o.write(new Blob(["x"])),await o.close()}}catch(t){const n=t?.name??String(t??"");if("UnknownError"===n)return 2}return 1}async isIncognitoFirefox(){try{const t=navigator.storage,e=!(!t||"function"!=typeof t.getDirectory);if(e){const i=await t.getDirectory(),s=await i.getFileHandle("probe.txt",{create:!0}),r=await s.createWritable();await r.write(new Blob(["x"])),await r.close()}}catch{return-2}return-1}async _detectIncognitoMode(){try{const{engine:t,flavor:e}=this.detectBrowser();return"Chromium"===t?await this.isIncognitoChromium(e):"WebKit"===t?await this.isIncognitoSafari():"Gecko"===t?await this.isIncognitoFirefox():-1}catch(t){return this.logger.error("[FIRSTID] Error detecting incognito mode:",t),-1}}getIncognitoMode(){return this.incognitoModeStatus}}function g(){return new l}window.FirstIdSdk=r.default})();